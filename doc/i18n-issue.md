## 標題

i18n: 語系切換顯示 key / 語系檔未載入 (zh-TW / en-US)

## 摘要

使用者在切換語系時，畫面顯示未翻譯的 key（例如 `form.name`、`users.title`），Console 顯示大量警告：
`[intlify] Not found '...key' key in 'en' locale messages.`

此 issue 彙整現象、重現步驟、根本原因分析，以及建議的修正步驟與驗證方法。

## 環境

- Nuxt 3
- 模組：`@nuxtjs/i18n`（lazy loading 啟用）
- 語系檔位置：`i18n/language/en.json`, `i18n/language/tw.json`
- 部分先前變更：`nuxt.config.ts` 的 `i18n.langDir` 曾被設定為不同值（導致不一致）

## 重現步驟

1. 啟動開發伺服器 `pnpm dev`
2. 開啟首頁 `/`，右上拉選切換語系到 `en-US`
3. 觀察頁面與瀏覽器 Console

## 觀察到的行為

- 頁面多處顯示 key（例如 `form.name`、`action.create`），而非翻譯文字。
- Console 顯示 `[intlify] Not found '...key' key in 'en' locale messages.`
- 此現象在切換回中文（`zh-TW`）時也可能出現（若語系檔都找不到）。

## 根本原因

1. `i18n.langDir` 與實際語系檔路徑不一致：
   - 專案的語系檔位於 `i18n/language/`，但 `nuxt.config.ts` 可能配置為 `language` 或其他，導致 @nuxtjs/i18n lazy-load 時找不到檔案。
2. 語系切換方式若僅呼叫 `locale.value = 'en-US'` 或 `setLocale`，在 @nuxtjs/i18n 下不一定會觸發路由與模組的正確初始化，應使用路由切換（`useLocalePath()` + `navigateTo()`）來切換語系路由。
3. 另外注意：unplugin-vue-i18n 的 linked-format 或 token 解析（例如特殊字元 `@` 或大括號）可能導致翻譯解析錯誤，要避免直接在 JSON 中使用會被解析的語法，採用參數化或 escape。

## 建議修正（優先順序）

1. 修正 `langDir`（最簡單且推薦）
   - 在 `nuxt.config.ts` 中將 `i18n.langDir` 設為實際位置 `i18n/language/`（或把語系檔搬到 `language/`）
   - 範例：
     ```ts
     i18n: {
       lazy: true,
       langDir: 'i18n/language/',
       ...
     }
     ```
2. 改用路由切換以觸發 i18n（參考文章）：
   - 使用 `const localePath = useLocalePath()` 與 `navigateTo(localePath(route.path, targetLang), { replace: true })`，確保路由與語系一致，觸發模組載入。
3. （選項）在元件內安全載入/註冊語系檔：
   - 若需要程式化載入，可在切換時 dynamic import 對應 JSON，並用 `setLocaleMessage(code, messages)` 註冊後再切換 `locale.value`。
4. 檢查並避免 JSON 中會被 linked-format 解析的字串（例如 `{...}`、含 `@` 的片段），改用參數化或 escape（或把該字串用 fallback 顯示），以免造成解析錯誤。

## 驗證步驟

1. 修改完 `nuxt.config.ts` 或搬檔後，重啟 dev server：
   ```bash
   pnpm dev
   ```
2. 在瀏覽器切換語系至 `en-US` 與 `zh-TW`，確認畫面中文字正確顯示，並且 Console 不再看到 `[intlify] Not found` 的警告。
3. 若仍有缺鍵，打開 Network 檢查對應 lazy-load 的 JSON 是否 404，或在 Console 查看動態 import 的錯誤。

## 風險與注意事項

- 修改 `langDir` 會影響到模組在 build 時如何尋找語系檔，請確保 CI/build pipeline 的路徑也同步。
- 若使用文章建議的路由切換，請注意應把頁面內的所有連結替換為 `nuxt-link-locale`（或使用 `useLocalePath`）以維持 route locale 一致性。
- 與 Pinia/SSR 相關的其他問題（如非純物件在 state）已在另一 issue 處理；本 issue 只聚焦 i18n 檔案載入與切換行為。

## 建議 PR checklist

- [ ] 更新 `nuxt.config.ts` 的 `langDir` 或移動語系檔案
- [ ] 使用 `useLocalePath` + `navigateTo` 更新語系切換程式碼（若尚未）
- [ ] 檢查 `i18n/language/*.json` 是否含 linked-format 風險字串並修正或參數化
- [ ] 在本地透過 `pnpm dev` 驗證並截圖 Console
- [ ] 更新 `doc/i18n-issue.md`（本檔）並在 PR 中引用

## 參考

- 原始討論與 debug logs（Console 中的 `[intlify] Not found`）
- 文章：Nuxt + @nuxtjs/i18n 使用注意事項（https://juejin.cn/post/7369201045790670889）

---

Generated by dev-assistant to track and fix i18n lazy-load / switching issues.
